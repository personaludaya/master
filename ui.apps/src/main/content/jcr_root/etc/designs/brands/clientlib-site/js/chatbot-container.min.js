"use strict";var $=require("jquery");require("typed.js"),require("api.ai");var shared_1=require("./shared"),_=require("underscore");require("jquery.visible");var chatbotTemplate=require("chatbot-product-info-partial"),SERVER_PROTO="wss",SERVER_DOMAIN="api-ws.api.ai",TTS_DOMAIN="api.api.ai",SERVER_PORT="4435",ACCESS_TOKEN="9df32f4839ff408089222f118d8f266b",SERVER_VERSION="20150910",Chatbot=function(){function t(){this.loader=new shared_1.Loader,this.sessionId=this.generateSession(32),this.endpoint="/services/chatbot/search.json",this.config={server:SERVER_PROTO+"://"+SERVER_DOMAIN+":"+SERVER_PORT+"/api/ws/query",serverVersion:SERVER_VERSION,token:ACCESS_TOKEN,sessionId:this.sessionId},this.chatbotGlobal=".chatbot-global",this.chatbotComponent=".chatbot-component",this.chatbotWrapper=".chatbot-wrapper",this.loaderWrapper=".loader",this.chatbotmsgId="#chatbotmsg",this.globalchatbotmsgId="#globalchatbotmsg",this.chatbotsendId="#btnsend",this.globalChatbotsendId="#btnsendglobal",this.chatbotResults=".results",this.chatbotWelcome=".chatbot-welcome",this.chatbotHelp=".chatbot-help",this.chatbotMessagebox=".chatbot-messagebox",this.fromUserTemplate=_.template('<div class="from-user"><div class="message"><%- message %></div></div>'),this.fromChatbotTemplate=_.template('<div class="from-chatbot"><div class="message <%= cssclass %>"><%= message %></div></div>'),this.fromChatbotLoaderTemplate=_.template('<div class="from-chatbot"><%= message %></div>'),this.chatbotNotMatch=_.template('Oops! We can’t find what you’re looking for. Would you like to know about <a href="<%= ourproductURL %>" target="_self">Our Products</a>, <a href="<%= bemagazineURL %>" target="_self">Lifestyle Articles</a>, <a href="<%= faqURL %>" target="_self">our products FAQ</a>?'),this.chatbotHelloTemplate=_.template('Hello to you again! Would you like to know more about <a href="<%= ourproductURL %>" target="_self">Our Products</a>, <a href="<%= bemagazineURL %>" target="_self">Lifestyle Articles</a>, <a href="<%= faqURL %>" target="_self">our products FAQ</a>?'),this.chatbotNoInteractionTemplate=_.template('If that’s not what you’re looking for, would you like to know more about <a href="<%= ourproductURL %>" target="_self">Our Products</a>, <a href="<%= bemagazineURL %>" target="_self">Lifestyle Articles</a>, <a href="<%= faqURL %>" target="_self">our products FAQ</a>?'),this.chatbotNoInteractionHelloTemplate=_.template("Oops! Looks like you need some help. Would you like to get in touch with our customer service?"),this.chatbotNoInteractionHelloYesTemplate=_.template('Here’s how you can get in touch with us! <a href="<%= customerserviceURL %>" target="_self">Customer Service</a>'),this.chatbotRedirectTemplate=_.template("Redirecting to <%= url%>"),this.chatbotOpenTabTemplate=_.template("Opening <%= url%>"),this.chatbotLoaderTemplate=_.template('<h4 class="message conversation-loader">.<span>..</span></h4>'),this.countryCode="sg",this.localeCode="en",this.customerSvcPath="",this.storeLocationPath="",this.ourProductsPath="",this.faqPath="",this.beMagPath="",this.ecstorePromotionsPath="",this.redirectTimeout=750,this.isInlineResult=!1,this.lastQueryScrollTop=0,this.chatbotTextList=[".."],this.chatbotTransitionDuration=1e3,this.utils=new shared_1.Utils,this.maxInlineResultToDisplay=3,this.chatbotNoInteractionTimeout=5e3,this.chatbotNoInteractionTimer=!1,this.recentUserQuery=!1,this.init()}return t.prototype.generateSession=function(t){for(var e="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=0;a<t;a++)e+=o.charAt(Math.floor(Math.random()*o.length));return e},t.prototype.typedAnimate=function(){$(this.chatbotWrapper+":visible").find("h4.message.conversation-loader span").typed({strings:this.chatbotTextList,loop:!0,typeSpeed:500,showCursor:!1})},t.prototype.initChatbotNoInteractionTimer=function(t){var e=this;void 0===t&&(t=!1),this.chatbotNoInteractionTimer&&clearTimeout(this.chatbotNoInteractionTimer),this.chatbotNoInteractionTimer=setTimeout(function(){var o="";o="hello"==t?e.chatbotNoInteractionHelloTemplate({ourproductURL:e.ourProductsPath,bemagazineURL:e.beMagPath,faqURL:e.faqPath,customerserviceURL:e.customerSvcPath}):e.chatbotNoInteractionTemplate({ourproductURL:e.ourProductsPath,bemagazineURL:e.beMagPath,faqURL:e.faqPath,customerserviceURL:e.customerSvcPath});$(e.chatbotResults+":visible").append(e.fromChatbotTemplate({message:o,cssclass:"no-bg"}))},this.chatbotNoInteractionTimeout),window.brands.chatbot.chatbotNoInteractionTimer=this.chatbotNoInteractionTimer},t.prototype.init=function(){var t=this;this.apiAICustom=new shared_1.ApiAICustom,this.apiAICustom.onError=function(e,o){t.onError(e,o)},this.apiAICustom.onResults=function(e){t.onResults(e)};var e=function(){var e=".btnchatbot";if($(window).width()<=window.brands.mobile_screen&&$(".chatbot-component").hide(),"none"==$("#chatbot-global").css("display")){$(e).addClass("active"),$("#chatbot-global").removeClass("hide").addClass("show"),$(".navbar-collapse").removeClass("in"),t.utils.chatbotUserInteraction(),$(window).width()<=window.brands.mobile_screen&&$("#header").height($(window).height()),$("#chatbot-global").animate({scrollTop:$("#chatbot-global").prop("scrollHeight")},500);var o={event:{eventInfo:{eventType:"chatbot_initiate",eventName:"header|search"}},search:{category:{primaryCategory:"Chat Bot"},attributes:{source:location.href}}};window.brands.tracker&&window.brands.tracker.customTrack(o)}else $("#chatbot-global").removeClass("show").addClass("hide"),$(e).removeClass("active")};$(document).ready(function(){t.utils.chatbotUserInteraction(),$("#siteCountry").val()&&(t.countryCode=$("#siteCountry").val()),$("#siteLangCode").val()&&(t.localeCode=$("#siteLangCode").val()),$("#customerSvcPath").val()&&(t.customerSvcPath=$("#customerSvcPath").val()),$("#storeLocationPath").val()&&(t.storeLocationPath=$("#storeLocationPath").val()+"#chatbot"),$("#ourProductsPath").val()&&(t.ourProductsPath=$("#ourProductsPath").val()+"#chatbot"),$("#faqPath").val()&&(t.faqPath=$("#faqPath").val()+"#chatbot"),$("#beMagPath").val()&&(t.beMagPath=$("#beMagPath").val()+"#chatbot"),$("#ecstorePromotionsPath").val()&&(t.ecstorePromotionsPath=$("#ecstorePromotionsPath").val()+"#chatbot"),$(t.chatbotHelp+","+t.chatbotMessagebox).fadeTo(500,1),$(t.globalchatbotmsgId).on("keypress",function(e){13===e.which&&t.onSendClicked(e,$(e.currentTarget).val())}),$(t.chatbotmsgId).on("focus",function(o){$(window).width()<=window.brands.mobile_screen&&(e(),$(t.globalchatbotmsgId).length>0&&$(t.globalchatbotmsgId).focus())}),$(t.chatbotmsgId).on("keypress",function(o){13===o.which&&($(window).width()<=window.brands.mobile_screen?(e(),t.onSendClicked(o,$("#chatbotmsg").val())):t.onSendClicked(o,$("#chatbotmsg").val()))}),$(t.globalChatbotsendId).on("click",function(e){t.onSendClicked(e,$(t.globalchatbotmsgId).val())}),$(t.chatbotsendId).on("click",function(o){$(window).width()<=window.brands.mobile_screen?(e(),t.onSendClicked(o,$("#chatbotmsg").val())):t.onSendClicked(o,$("#chatbotmsg").val())})})},t.prototype.onSendClicked=function(t,e){var o=this;if(e){this.chatbotNoInteractionTimer&&clearTimeout(this.chatbotNoInteractionTimer);var a=this.chatbotComponent+", "+this.chatbotGlobal;$(window).width()<=window.brands.mobile_screen&&(a=this.chatbotGlobal,$(this.chatbotComponent).find(this.chatbotWrapper).find(".results").html(this.fromChatbotLoaderTemplate({message:'<h4 class="message no-bg still-looking">Still looking? Perhaps try another word</h4>'}))),$(a).find(this.chatbotWrapper+":visible").find("h1.message").length>0&&($(a).find(this.chatbotHelp+":visible").remove(),$(a).find(this.chatbotWrapper+":visible").find(".results").html(""),$(a).find(this.chatbotWrapper+":visible").css({"overflow-y":"auto"})),$(a).find(this.chatbotWrapper).is(":visible")||$(a).find(this.chatbotWrapper).show();$(a).find(this.chatbotResults).append(this.fromUserTemplate({message:e}));$(a).find(this.chatbotResults).append(this.fromChatbotLoaderTemplate({message:this.chatbotLoaderTemplate()})),this.typedAnimate(),$(this.chatbotWrapper+":visible").animate({scrollTop:$(this.chatbotWrapper+":visible").prop("scrollHeight")},1,"swing",function(){if($(window).width()<=window.brands.mobile_screen?o.lastQueryScrollTop=$(".from-user").last().prop("offsetTop")-350:o.lastQueryScrollTop=$(".from-user").last().prop("offsetTop")+$(".from-user").last().height(),"hello"==e.toLowerCase()||o.recentUserQuery&&"hello"==o.recentUserQuery.toLowerCase()&&"yes"==e.toLowerCase()){var t=o.chatbotHelloTemplate({ourproductURL:o.ourProductsPath,bemagazineURL:o.beMagPath,faqURL:o.faqPath,customerserviceURL:o.customerSvcPath});"yes"==e.toLowerCase()&&(t=o.chatbotNoInteractionHelloYesTemplate({ourproductURL:o.ourProductsPath,bemagazineURL:o.beMagPath,faqURL:o.faqPath,customerserviceURL:o.customerSvcPath})),$(o.chatbotWrapper+":visible").find(o.chatbotResults).find(".conversation-loader").parent().remove();var a=$(o.chatbotResults+":visible").append(o.fromChatbotTemplate({message:t,cssclass:"no-bg"}));return $(o.chatbotmsgId).val(""),$(o.globalchatbotmsgId).val(""),$(o.chatbotWrapper+":visible").animate({scrollTop:o.lastQueryScrollTop},500),a&&window.brands.tracker&&window.brands.tracker.initDataAnalytics(a),"hello"==e.toLowerCase()&&o.initChatbotNoInteractionTimer("hello"),void(o.recentUserQuery=e)}o.apiAICustom.sendQuery(e),o.recentUserQuery=e})}},t.prototype.sendQuery=function(t){this.apiAI.sendJson({v:"20150512",query:t,timezone:"GMT+8",lang:"en",sessionId:this.sessionId})},t.prototype.onInit=function(){this.apiAI.open()},t.prototype.onStart=function(){},t.prototype.onStop=function(){},t.prototype.onOpen=function(){},t.prototype.onClose=function(){this.apiAI.close()},t.prototype.onError=function(t,e){},t.prototype.onEvent=function(t,e){},t.prototype.onResults=function(t){var e=this;this.isInlineResult=!1;var o=this.chatbotNotMatch({ourproductURL:this.ourProductsPath,bemagazineURL:this.beMagPath,faqURL:this.faqPath,customerserviceURL:this.customerSvcPath}),a=function(t,a){var r=!1;r=t?$(e.chatbotResults+":visible").append(t):$(e.chatbotResults+":visible").append(e.fromChatbotTemplate({message:o,cssclass:"no-bg"})),$(e.chatbotmsgId).val(""),$(e.globalchatbotmsgId).val(""),a||$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),$(e.chatbotWrapper+":visible").animate({scrollTop:e.lastQueryScrollTop},500),r&&window.brands.tracker&&window.brands.tracker.initDataAnalytics(r),e.initChatbotNoInteractionTimer()},r=t.result.resolvedQuery;if(!t.result.parameters)return window.brands.tracker&&window.brands.tracker.trackChatbotResult(r,0,!1),void a();var s=[];t.result.parameters.chatbotphrase&&s.push(encodeURIComponent(t.result.parameters.chatbotphrase)),t.result.parameters.chatbotphrase1&&s.push(encodeURIComponent(t.result.parameters.chatbotphrase1)),t.result.parameters.chatbotphrase2&&s.push(encodeURIComponent(t.result.parameters.chatbotphrase2)),t.result.parameters.chatbotphrase3&&s.push(encodeURIComponent(t.result.parameters.chatbotphrase3));var i=t.result.parameters.type;s.length>1?s.push("compare"):"faq"==i?s.push("faq"):"product-price"==i&&s.push("price");var n="col-lg-3 col-md-4 col-sm-4 col-xs-6";if("none"!=$("#chatbot-global").css("display")&&(n="col-lg-6 col-md-6 col-sm-6 col-xs-6"),"promotions"==i){if(""!=this.ecstorePromotionsPath)return o=this.chatbotOpenTabTemplate({url:this.ecstorePromotionsPath}),$(this.chatbotWrapper+":visible").find(this.chatbotResults).find(".conversation-loader").parent().remove(),window.open(this.ecstorePromotionsPath),window.brands.tracker&&window.brands.tracker.trackChatbotResult(r,1,s),a()}else{if("store-locations"==i)return void(""!=this.storeLocationPath?(o=this.chatbotRedirectTemplate({url:this.storeLocationPath}),window.brands.tracker&&window.brands.tracker.trackChatbotResult(r,1,s),a(),_.delay(function(){if(window.brands.tracker){var t={event:{eventInfo:{eventType:"chatbot_click",eventName:"auto|store-locations"}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),window.brands.tracker.buildAnalyticsWithLocalStorage(e.storeLocationPath,t)}},this.redirectTimeout)):$(this.chatbotWrapper+":visible").find(this.chatbotResults).find(".conversation-loader").parent().remove());if("supports"==i)return void(""!=this.customerSvcPath?(o=this.chatbotRedirectTemplate({url:this.customerSvcPath}),window.brands.tracker&&window.brands.tracker.trackChatbotResult(r,1,s),a(),_.delay(function(){if(window.brands.tracker){var t={event:{eventInfo:{eventType:"chatbot_click",eventName:"auto|supports"}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),window.brands.tracker.buildAnalyticsWithLocalStorage(e.customerSvcPath,t)}},this.redirectTimeout)):$(this.chatbotWrapper+":visible").find(this.chatbotResults).find(".conversation-loader").parent().remove());if("our-products"==i)return void(""!=this.ourProductsPath?(o=this.chatbotRedirectTemplate({url:this.ourProductsPath}),window.brands.tracker&&window.brands.tracker.trackChatbotResult(r,1,s),a(),_.delay(function(){if(window.brands.tracker){var t={event:{eventInfo:{eventType:"chatbot_click",eventName:"auto|our-products"}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),window.brands.tracker.buildAnalyticsWithLocalStorage(e.ourProductsPath,t)}},this.redirectTimeout)):$(this.chatbotWrapper+":visible").find(this.chatbotResults).find(".conversation-loader").parent().remove())}this.fetchData(s).then(function(t){var c=t;if("compare"==i&&(c.totalResult=1),window.brands.tracker&&window.brands.tracker.trackChatbotResult(r,c.totalResult,s),c&&c.totalResult>0&&c.results.length>0){e.isInlineResult=!0;var l=e.fromChatbotTemplate({message:"Here's what I found",cssclass:"no-bg"})+'<div class="row inline-chatbot-result">',h=_.chain(c.results).groupBy("type").map().first(e.maxInlineResultToDisplay).value();h=_.chain(h).map(function(t,o){return _.first(t,e.maxInlineResultToDisplay-h.length+1)}).flatten().value();for(var d=function(t){var h=c.results[t],d={event:{eventInfo:{eventType:"chatbot_click"}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};switch(h.type){case"product":if(d.event.eventInfo.eventName="link|product",h.dataAnalytics=JSON.stringify(d),1==c.totalResult)return"product-price"==i?(o=e.chatbotOpenTabTemplate({url:h.pageurl}),d.event.eventInfo.eventName="auto|product-price",_.delay(function(){window.brands.tracker&&window.brands.tracker.customTrack(d),$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),window.open(h.pageurl)},e.redirectTimeout)):(o=e.chatbotRedirectTemplate({url:h.pageurl}),_.delay(function(){if(window.brands.tracker&&window.brands.tracker.customTrack(d),$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),window.brands.tracker){var t={event:{eventInfo:{eventType:"chatbot_click",eventName:"auto|product"}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};window.brands.tracker.buildAnalyticsWithLocalStorage(h.pageurl,t)}},e.redirectTimeout)),{value:a()};l+='<div class="'+n+'">',l+=chatbotTemplate.template({product:h}),l+="</div>";break;case"faq":if(d.event.eventInfo.eventName="link|faq",h.bulletList&&h.bulletList.length>0){h.content+="<ul>";for(var u=0;u<h.bulletList.length;u++)h.content+="<li>"+h.bulletList[u]+"</li>";h.content+="</ul>"}return o=h.content,{value:a()};case"promotions":return d.event.eventInfo.eventName="link|promotions",_.delay(function(){$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),location.href=e.ecstorePromotionsPath},e.redirectTimeout),{value:a()};case"compare":return d.event.eventInfo.eventName="link|compare",o=e.chatbotRedirectTemplate({url:c.viewMoreUrl}),_.delay(function(){if($(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),window.brands.tracker){var t={event:{eventInfo:{eventType:"chatbot_click",eventName:"auto|compare"}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};window.brands.tracker.buildAnalyticsWithLocalStorage(c.viewMoreUrl,t)}},e.redirectTimeout),{value:a()};default:if(d.event.eventInfo.eventName="link|"+h.type,h.dataAnalytics=JSON.stringify(d),1==c.totalResult)return o=e.chatbotRedirectTemplate({url:c.viewMoreUrl}),_.delay(function(){if(window.brands.tracker&&window.brands.tracker.customTrack(d),$(e.chatbotWrapper+":visible").find(e.chatbotResults).find(".conversation-loader").parent().remove(),window.brands.tracker){var t={event:{eventInfo:{eventType:"chatbot_click",eventName:"auto|"+h.type}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};window.brands.tracker.buildAnalyticsWithLocalStorage(h.pageurl,t)}},e.redirectTimeout),{value:a()};l+='<div class="'+n+'">',l+=chatbotTemplate.template({product:h}),l+="</div>"}},u=0;u<h.length;u++){var b=d(u);if("object"==typeof b)return b.value}l+="</div>";var p={event:{eventInfo:{eventType:"chatbot_click",eventName:"link|view-more"}},search:{searchInfo:{term:r},category:{primaryCategory:"Chat Bot",subCategory:s?s.join(","):""}}};l+=e.fromChatbotTemplate({message:"<a href='"+c.viewMoreUrl+"' data-analytics='"+JSON.stringify(p)+"'>See what else I found</a>",cssclass:""}),a(l)}else a()})},t.prototype.fetchData=function(t){var e=$.Deferred();return $.ajax({url:this.endpoint+"?ctry="+this.countryCode+"&loc="+this.localeCode+"&q[]="+t.join("&q[]="),contentType:"application/json; charset=utf-8;",dataType:"text",success:function(t){"string"==typeof t&&(t=JSON.parse(t)),e.resolve(t)},error:function(t){e.reject(t)}}),e.promise()},t}();new Chatbot;